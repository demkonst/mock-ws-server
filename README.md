# Mock WebSocket Server

Сервер для симуляции операторов и транспортных средств с поддержкой различных окружений.

## Возможности

- **Симуляция операторов** через WebSocket соединения
- **Симуляция транспортных средств** через HTTP POST запросы
- **Поддержка множественных окружений** (dev, demo, stage)
- **Автоматическая интерполяция координат** с учётом скорости движения
- **Управление процессами** через REST API
- **Автоматические уведомления** с периодической отправкой
- **Автоматическое управление сменами** через внешний API

## Установка

```bash
npm install
```

## Запуск

```bash
node server.js
```

Сервер запустится на порту 3000.

## API Документация

Swagger UI доступен по адресу: http://localhost:3000/api-docs

Интерактивная документация API с возможностью тестирования эндпоинтов.

## API Endpoints

### POST /run
Запускает симуляцию операторов и/или транспортных средств.

**Параметры:**
- `env` (string) - окружение (dev, demo, stage)
- `operators` (array) - массив имён операторов для запуска
- `vehicles` (array) - массив имён транспортных средств для запуска
- `speed` (number) - скорость движения в м/с (переопределяет значение из файла)
- `duration` (number) - длительность симуляции в секундах (по умолчанию 300)
- `notifications` (boolean) - включить автоматические уведомления
- `allOperators` (boolean) - запустить всех операторов окружения
- `allVehicles` (boolean) - запустить все транспортные средства окружения
- `vehicleCoords` (object) - кастомные координаты для транспортных средств в формате `{"vehicle_name": [{"lat": 58.03256597, "lon": 106.54683029}, ...]}`
- `operatorCoords` (object) - кастомные координаты для операторов в формате `{"operator_name": [[lon, lat], [lon, lat], ...]}`

**Примеры:**

```bash
# Запуск всех процессов в dev окружении
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{"env": "dev"}'

# Запуск транспортных средств с файловой скоростью
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{"env": "dev", "vehicles": ["11", "12"]}'

# Запуск с переопределением скорости из запроса
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{"env": "dev", "vehicles": ["11", "12"], "speed": 15}'

# Запуск с уведомлениями
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{"env": "dev", "notifications": true}'

# Запуск с кастомными координатами
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{
    "env": "dev", 
    "vehicles": ["custom_route"], 
    "speed": 8,
    "vehicleCoords": {
      "custom_route": [
        {"lat": 58.03256597, "lon": 106.54683029},
        {"lat": 58.03409, "lon": 106.5384},
        {"lat": 58.03890375, "lon": 106.53784625}
      ]
    }
  }'

# Запуск всех файлов (обратная совместимость)
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{"env": "dev"}'
```

### GET /status
Возвращает текущий статус сервера или конкретного окружения.

**Параметры:**
- `env` (string, опционально) - окружение для проверки статуса (dev, demo, stage). Если не указано, возвращается общий статус всех окружений.

**Примеры:**

```bash
# Общий статус всех окружений
curl http://localhost:3000/status

# Статус конкретного окружения
curl "http://localhost:3000/status?env=dev"
```

**Ответы:**

**Общий статус (массив окружений):**
```json
[
  { "env": "dev", "status": "running" },
  { "env": "demo", "status": "stopped" },
  { "env": "stage", "status": "running" }
]
```

**Статус конкретного окружения (простой статус):**
```json
{ "status": "running" }
```

### POST /stop
Останавливает все запущенные процессы или процессы конкретного окружения.

**Параметры:**
- `env` (string, опционально) - окружение для остановки (dev, demo, stage). Если не указано, останавливаются все процессы.

**Примеры:**

```bash
# Остановить все процессы
curl -X POST http://localhost:3000/stop

# Остановить только процессы dev окружения
curl -X POST http://localhost:3000/stop \
  -H "Content-Type: application/json" \
  -d '{"env": "dev"}'
```

## Интерполяция координат

Система автоматически интерполирует координаты между заданными точками маршрута с учётом указанной скорости:

### Приоритет настроек скорости:
1. **Параметр `speed` в запросе** - высший приоритет
2. **Параметр `speed` в JSON файле** - средний приоритет  
3. **Значение по умолчанию (10 м/с)** - низший приоритет

- **Входные данные:** массив координат (waypoints) в JSON файлах
- **Алгоритм:** линейная интерполяция с расчётом времени на основе расстояния и скорости
- **Результат:** плавное движение с реалистичной скоростью

**Пример файла транспортного средства:**
```json
{
  "client": 632295,
  "moving": true,
  "speed": 10,
  "coords": [
    {"lat": 58.03256597, "lon": 106.54683029},
    {"lat": 58.03409, "lon": 106.5384},
    {"lat": 58.03890375, "lon": 106.53784625}
  ]
}
```

### Кастомные координаты

Помимо чтения координат из файлов, можно передавать их напрямую в запросе `/run` через параметры `vehicleCoords` и `operatorCoords`. Это удобно для быстрого тестирования различных маршрутов без создания файлов.

**Приоритет координат:**
1. **Кастомные координаты из запроса** - высший приоритет
2. **Координаты из JSON файлов** - низший приоритет

**Обратная совместимость:**
- Если не указаны никакие параметры (`operators`, `vehicles`, `allOperators`, `allVehicles`, `vehicleCoords`, `operatorCoords`), система автоматически запускает все доступные файлы в указанном окружении
- Это обеспечивает совместимость с существующими запросами

#### Для транспортных средств (`vehicleCoords`)

**1. Простой массив координат (используется дефолтный client ID = 999999):**
```json
{
  "vehicleCoords": {
    "vehicle_name": [
      [106.54683029, 58.03256597],
      [106.5384, 58.03409],
      [106.53784625, 58.03890375]
    ]
  }
}
```

**2. Объект с координатами и client ID:**
```json
{
  "vehicleCoords": {
    "vehicle_name": {
      "coords": [
        [106.54683029, 58.03256597],
        [106.5384, 58.03409],
        [106.53784625, 58.03890375]
      ],
      "client": 123456,
      "speed": 15,
      "interpolate": true
    }
  }
}
```

**Кастомные параметры для транспортных средств:**
- `speed` (number) - скорость в м/с (по умолчанию 10 м/с)
- `interpolate` (boolean) - интерполяция координат (по умолчанию true)

#### Для операторов (`operatorCoords`)

**1. Простой массив координат (используется токен из окружения):**
```json
{
  "operatorCoords": {
    "operator_name": [
      [106.54683029, 58.03256597],
      [106.5384, 58.03409],
      [106.53784625, 58.03890375]
    ]
  }
}
```

**2. Объект с координатами и operator_id:**
```json
{
  "operatorCoords": {
    "operator_name": {
      "coords": [
        [106.54683029, 58.03256597],
        [106.5384, 58.03409],
        [106.53784625, 58.03890375]
      ],
      "operator_id": 123456,
      "speed": 60,
      "course": 45,
      "altitude": 15,
      "delay": 3000,
      "interpolate": true
    }
  }
}
```

**Кастомные параметры для операторов:**
- `speed` (number) - скорость в км/ч (по умолчанию 40)
- `course` (number) - курс в градусах (по умолчанию 90)
- `altitude` (number) - высота в метрах (по умолчанию 10)
- `delay` (number) - задержка между сообщениями в миллисекундах (по умолчанию 2000)
- `interpolate` (boolean) - интерполяция координат (по умолчанию true)

**Примечание:** При использовании `operator_id` система автоматически:
1. Делает запрос `/api/units/operators/credentials?operator_id={{operator_id}}`
2. Получает credentials (login/password)
3. Делает запрос `/api/units/auth/operator/login` для получения токена
4. Использует полученный токен для WebSocket подключения
    {"lat": 58.03890375, "lon": 106.53784625}
  ]
}
```

**Параметры файла:**
- `client` (number) - ID клиента
- `moving` (boolean) - статус движения
- `speed` (number) - скорость в м/с (опционально, по умолчанию 10 м/с)
- `coords` (array) - массив координат маршрута

**Поддерживаемые форматы координат в файлах:**

**1. Старый формат (объект):**
```json
{
  "client": 632295,
  "moving": true,
  "speed": 10,
  "coords": [
    {"lat": 58.03256597, "lon": 106.54683029},
    {"lat": 58.03409, "lon": 106.5384}
  ]
}
```

**2. Новый формат (массив):**
```json
{
  "client": 999888,
  "moving": true,
  "speed": 8,
  "coords": [
    [106.54683029, 58.03256597],
    [106.5384, 58.03409]
  ]
}
```

**Примечание:** В массиве координаты идут в порядке `[lon, lat]` (долгота, широта).

## Структура файлов

```
mock-ws-server/
├── operators_<env>/          # Операторы для каждого окружения
│   ├── operator_01.json     # Старый формат (массив сообщений)
│   ├── operator_02.json     # Старый формат (массив сообщений)
│   └── operator_new_format.json # Новый формат (waypoints)
├── vehicles_<env>/           # Транспортные средства для каждого окружения
│   ├── vehicle_11.json      # Старый формат координат
│   ├── vehicle_12.json      # Старый формат координат
│   └── vehicle_new_format.json # Новый формат координат
├── .env.<env>               # Конфигурация для каждого окружения
├── server.js                # Основной сервер
├── operator.js              # Логика операторов
├── vehicle.js               # Логика транспортных средств
└── vehicleRunner.js         # Управление транспортными средствами
```

## Форматы файлов операторов

### Старый формат (массив сообщений)
```json
[
  {
    "payload": {
      "lat": 58.03256597,
      "lon": 106.54683029,
      "timestamp": 1753387738,
      "speed": 40,
      "speed_accuracy": 1,
      "course": 90,
      "course_accuracy": 5,
      "altitude": 10,
      "altitude_accuracy": 2
    },
    "delay": 2000
  }
]
```

### Новый формат (waypoints)
```json
{
  "waypoints": [
    [106.54683029, 58.03256597],
    [106.5384, 58.03409],
    [106.53784625, 58.03890375]
  ],
  "speed": 40,
  "course": 90,
  "altitude": 10,
  "delay": 2000,
  "interpolate": true
}
```

**Примечание:** В массиве координаты идут в порядке `[lon, lat]` (долгота, широта).

**Интерполяция:** 
- `"interpolate": true` (по умолчанию) - система автоматически генерирует промежуточные точки между waypoints на основе указанной скорости и интервала задержки
- `"interpolate": false` - используются только указанные waypoints без генерации промежуточных точек

**Рекомендация:** Если у вас маршруты специально спроектированы так, чтобы точки не пересекались, используйте `"interpolate": false`.

## Форматы файлов транспортных средств

### Старый формат (массив координат)
```json
{
  "client": 999888,
  "moving": true,
  "speed": 8,
  "coords": [
    { "lat": 58.03256597, "lon": 106.54683029 },
    { "lat": 58.03409, "lon": 106.5384 },
    { "lat": 58.03890375, "lon": 106.53784625 }
  ]
}
```

### Новый формат (waypoints)
```json
{
  "client": 999888,
  "moving": true,
  "speed": 8,
  "interpolate": true,
  "coords": [
    [106.54683029, 58.03256597],
    [106.5384, 58.03409],
    [106.53784625, 58.03890375]
  ]
}
```

**Примечание:** В массиве координаты идут в порядке `[lon, lat]` (долгота, широта).

**Интерполяция:** 
- `"interpolate": true` (по умолчанию) - система автоматически генерирует промежуточные точки между waypoints на основе указанной скорости и интервала задержки
- `"interpolate": false` - используются только указанные waypoints без генерации промежуточных точек

**Рекомендация:** Если у вас маршруты специально спроектированы так, чтобы точки не пересекались, используйте `"interpolate": false`.

## Конфигурация окружений

Создайте файлы `.env.dev`, `.env.demo`, `.env.stage` с настройками:

```env
# Базовые URL для разных сервисов
BASE_URL_CONNECTOR=https://your-domain.com/api/connector/
BASE_URL_COLLECTOR=https://your-domain.com/api/collector/
BASE_URL_UNITS=https://your-domain.com/api/units/
BASE_URL_STREAMER=https://your-domain.com/api/streamer/
```

### Описание переменных

- **BASE_URL_CONNECTOR** - URL для connector сервиса (используется для отправки координат транспортных средств)
- **BASE_URL_COLLECTOR** - URL для collector сервиса (используется для WebSocket подключений операторов)
- **BASE_URL_UNITS** - URL для units сервиса (используется для работы с операторами и сменами)
- **BASE_URL_STREAMER** - URL для streamer сервиса (используется для отправки уведомлений)

## Автоматические функции

### Управление сменами
Перед запуском процессов система автоматически:
1. Проверяет наличие активных смен
2. При отсутствии смен получает шаблоны
3. Создаёт новые смены на текущую дату

### Уведомления
При включении флага `notifications: true`:
- Отправляет уведомления каждые 3 минуты
- Использует случайные сообщения из предустановленного списка
- Останавливается при выполнении `/stop`

## Логирование

Система предоставляет подробное логирование:
- `🔄 [Interpolation]` - информация об интерполяции координат
- `📤 [Vehicle]` - отправка данных транспортного средства
- `✅ [Vehicle]` - успешные запросы
- `❌ [Vehicle]` - ошибки
- `🛑` - остановка процессов 