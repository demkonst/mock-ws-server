# Mock WebSocket Server

Сервер для имитации работы операторов и транспорта через WebSocket и HTTP.

## Возможности

- **WebSocket операторы**: Отправка координат через WebSocket соединения
- **HTTP транспорт**: Отправка телеметрии через HTTP запросы
- **Автоматическая остановка**: При получении нового запроса старые процессы автоматически останавливаются
- **Таймауты**: Настройка длительности работы процессов

## API Endpoints

### POST /run
Запускает новые процессы операторов и транспорта.

**Параметры:**
- `env` (string, опционально): Окружение (по умолчанию 'demo')
- `duration` (number, опционально): Длительность в секундах

**Пример:**
```bash
curl -X POST http://localhost:3000/run \
  -H "Content-Type: application/json" \
  -d '{"env": "demo", "duration": 60}'
```

### POST /stop
Принудительно останавливает все активные процессы.

**Пример:**
```bash
curl -X POST http://localhost:3000/stop
```

## Структура файлов

```
mock-ws-server/
├── server.js              # Основной сервер
├── runner.js              # Управление WebSocket операторами
├── transportRunner.js     # Управление HTTP транспортом
├── operator.js            # Логика операторов
├── transport.js           # Логика транспорта
├── operators/             # Конфигурации операторов
│   ├── operator_01.json
│   ├── operator_02.json
│   └── ...
├── vehicles/              # Конфигурации транспорта
│   ├── vehicle_12.json
│   ├── vehicle_16.json
│   └── ...
└── test-stop.js           # Тестовый скрипт
```

## Запуск

1. Установите зависимости:
```bash
npm install
```

2. Запустите сервер:
```bash
node server.js
```

3. Сервер будет доступен на `http://localhost:3000`

## Тестирование

Для проверки корректной остановки процессов:

```bash
node test-stop.js
```

## Особенности

### Автоматическая остановка процессов
При получении нового запроса `/run`:
1. Останавливаются все активные WebSocket соединения
2. Останавливаются все HTTP транспортные процессы
3. Очищаются все таймеры и реестры
4. Запускаются новые процессы

### Отслеживание процессов
- `wsRegistry`: Глобальный реестр WebSocket соединений
- `transportRegistry`: Глобальный реестр HTTP транспорта
- `runnerRegistry`: Реестр активных Runner'ов
- `transportRunnerRegistry`: Реестр активных TransportRunner'ов

### Безопасная остановка
- Все таймеры `setTimeout` отслеживаются и очищаются
- WebSocket соединения корректно закрываются
- HTTP процессы останавливаются через флаг `isRunning` 